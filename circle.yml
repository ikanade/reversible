machine:
  ruby:
    version: 2.4.1
  services:
    - docker
checkout:
  post:
    - chmod +x ./deploy.sh

dependencies:
  override:
    - $(aws ecr get-login --region us-east-1)
    - docker build -t reversible .

test:
  override:
    ## - docker run -e RAILS_ENV=test -it my-website rake test

deployment:
  prod:
    branch: master ## do deployment on commit to the master branch only 
    commands:
      - docker tag reversible $AWS_ACCOUNT_ID.dkr.ecr.us-east-1.amazonaws.com/reversible:$CIRCLE_SHA1
      - docker tag reversible $AWS_ACCOUNT_ID.dkr.ecr.us-east-1.amazonaws.com/reversible:latest
      - docker push $AWS_ACCOUNT_ID.dkr.ecr.us-east-1.amazonaws.com/reversible:$CIRCLE_SHA1
      - docker push $AWS_ACCOUNT_ID.dkr.ecr.us-east-1.amazonaws.com/reversible:latest
      - ./deploy.sh