machine:
  ruby:
    version: 2.4.1
  services:
    - docker
checkout:
  post:
    - chmod +x ./ecs_deploy_script

dependencies:
  override:
    - $(aws ecr get-login --region us-east-1)
    - docker build -t $AWS_ACCOUNT_ID.dkr.ecr.us-east-1.amazonaws.com/reversible:$CIRCLE_SHA1 .

test:
  post:
    - docker run -d -p 4000:80 $AWS_ACCOUNT_ID.dkr.ecr.us-east-1.amazonaws.com/reversible:$CIRCLE_SHA1; sleep 10

deployment:
  prod:
    branch: master ## do deployment on commit to the master branch only 
    commands:
      - docker push $AWS_ACCOUNT_ID.dkr.ecr.us-east-1.amazonaws.com/reversible:$CIRCLE_SHA1
      - ./ecs_deploy_script -c reversible-cluster -n reversible-service -i $AWS_ACCOUNT_ID.dkr.ecr.us-east-1.amazonaws.com/reversible:$CIRCLE_SHA1 -k $AWS_ACCESS_KEY_ID -s $AWS_SECRET_ACCESS_KEY -r us-east-1 -m 100 -v