machine:
  ruby:
    version: 2.4.1
  services:
    - docker
checkout:
  post:
    - chmod +x ./deploy.sh

dependencies:
  override:
    - $(aws ecr get-login --region us-east-1)
    - docker build -t reversible .

test:
  post:
    - docker run -d -p 4000:80 $AWS_ACCOUNT_ID.dkr.ecr.us-east-1.amazonaws.com/reversible:$CIRCLE_SHA1; sleep 10

deployment:
  prod:
    branch: master ## do deployment on commit to the master branch only 
    commands:
      - docker tag -f reversible $AWS_ACCOUNT_ID.dkr.ecr.us-east-1.amazonaws.com/reversible:$CIRCLE_SHA1
      - docker push $AWS_ACCOUNT_ID.dkr.ecr.us-east-1.amazonaws.com/reversible:$CIRCLE_SHA1
      - ./deploy.sh